{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "AKSClusterName": {
            "type": "String"
        },
        "vnetName": {
            "type": "string"
        },
        "subnetName": {
            "type": "string"
        },
        "serviceCidr": {
            "type": "string"
        },
        "dnsServiceIP": {
            "type": "string"
        },
        "dockerBridgeCidr": {
            "type": "string"
        },                           
        "DNSZone": {
            "type": "String"
        },
        "ManagedID": {
            "type": "string"
        },         
        "principalID": {
            "type": "String"
        },          
        "clientID": {
            "type": "String"
        },                   
        "location": {
            "type": "string",
            "metadata": {
            "description": "Region of Resources"
            }
        }        
    },
    "variables": {
        "subnetId": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]",
        "publicIPAddressName": "[concat(parameters('AKSClusterName'),'-pip')]"
    },
    "resources": [
        {
            "name": "[variables('publicIPAddressName')]",
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2018-11-01",
            "location": "[parameters('location')]",
            "properties": {
                "publicIPAllocationMethod": "Static"
            }
        }, 
        {
            "type": "Microsoft.ContainerService/managedClusters",
            "apiVersion": "2021-02-01",
            "name": "[parameters('AKSClusterName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
            ],              
            "sku": {
                "name": "Basic",
                "tier": "Free"
            },
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "[parameters('ManagedID')]":
                    {
                        "clientId": "[parameters('clientID')]",
                        "principalId": "[parameters('principalID')]"
                    }
                }
            },
            "properties": {
                "kubernetesVersion": "1.19.11",
                "fqdnSubdomain": "aks",
                "agentPoolProfiles": [
                    {
                        "name": "nodepool1",
                        "count": 3,
                        "vmSize": "Standard_DS2_v2",
                        "osDiskSizeGB": 128,
                        "osDiskType": "Managed",
                        "kubeletDiskType": "OS",
                        "vnetSubnetID": "[variables('subnetId')]",
                        "maxPods": 30,
                        "type": "VirtualMachineScaleSets",
                        "orchestratorVersion": "1.19.11",
                        "enableNodePublicIP": false,
                        "nodeLabels": {},
                        "mode": "System",
                        "enableEncryptionAtHost": false,
                        "osType": "Linux",
                        "osSKU": "Ubuntu",
                        "enableFIPS": false
                    }
                ],
                "linuxProfile": {
                    "adminUsername": "azureuser",
                    "ssh": {
                        "publicKeys": [
                            {
                                "keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCr7miRdf1igPA46Tz5AGGtqDpWB/jQW6KmMwuRZlvMOMxT4GrEdvFlaZCIlbqaC7bSoN0jV3kOyfnYMMz7d9RrVEi8BZTRKwAMyfLoxT/cwc3LtWgUt8W1ySZDY1G2Bfx24Bh1AcwUaQjzOgXvBPIzZc9KWao1M8GsHxt7V0Jw2gmWhBvptktSeMWlF/+YWgSoC1lkYIvYd2t/qmqDoZPdbVV811cUYIZOrx2IY3YMApbet/GqKJ7OsTcc0CmRx1FkS7sceOXooszQo5i92+ECMBdJDsloP4347xz0aFD2Wgt0wojqEuh4vjxNt31S3oJuPLmIvXqoQOd5m9B8BiIT"
                            }
                        ]
                    }
                },
                "windowsProfile": {
                    "adminUsername": "azureuser",
                    "enableCSIProxy": false
                },
                "servicePrincipalProfile": {
                    "clientId": "msi"
                },
                "nodeResourceGroup": "[concat('MC_Private-AKS-Lab01_', parameters('AKSClusterName'), parameters('location'))]",
                "enableRBAC": true,
                "networkProfile": {
                    "networkPlugin": "azure",
                    "loadBalancerSku": "Standard",
                    "loadBalancerProfile": {
                        "managedOutboundIPs": {
                            "count": 1
                        },
                        "effectiveOutboundIPs": [
                            {
                                "id": "[variables('publicIPAddressName')]"
                            }
                        ]
                    },
                    "serviceCidr": "[parameters('serviceCidr')]",
                    "dnsServiceIP": "[parameters('dnsServiceIP')]",
                    "dockerBridgeCidr": "[parameters('dockerBridgeCidr')]",
                    "outboundType": "loadBalancer"
                },
                "privateLinkResources": [
                    {
                        "id": "[concat(resourceId('Microsoft.ContainerService/managedClusters', parameters('AKSClusterName')), '/privateLinkResources/management')]",
                        "name": "management",
                        "type": "Microsoft.ContainerService/managedClusters/privateLinkResources",
                        "groupId": "management",
                        "requiredMembers": [
                            "management"
                        ]
                    }
                ],                
                "apiServerAccessProfile": {
                    "enablePrivateCluster": true,
                    "privateDNSZone": "[parameters('DNSZone')]"
                }
            }
        },
        {
            "type": "Microsoft.ContainerService/managedClusters/agentPools",
            "apiVersion": "2021-02-01",
            "name": "[concat(parameters('AKSClusterName'), '/nodepool1')]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('AKSClusterName'))]"
            ],
            "properties": {
                "count": 3,
                "vmSize": "Standard_DS2_v2",
                "osDiskSizeGB": 128,
                "osDiskType": "Managed",
                "kubeletDiskType": "OS",
                "vnetSubnetID": "[variables('subnetId')]",
                "maxPods": 30,
                "type": "VirtualMachineScaleSets",
                "orchestratorVersion": "1.19.11",
                "enableNodePublicIP": false,
                "nodeLabels": {},
                "mode": "System",
                "enableEncryptionAtHost": false,
                "osType": "Linux",
                "osSKU": "Ubuntu",
                "enableFIPS": false
            }
        }
    ]
}